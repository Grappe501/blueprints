// db/prisma/schema.prisma
// BLUEPRINTS â€” Phase 2 / Module 2.1
// Canonical data model with hard PUBLIC vs PRIVATE zone separation using Postgres schemas.
//
// - PUBLIC schema ("public"): safe for public pages and APIs.
// - PRIVATE schema ("private"): voter file + PII, restricted; RLS enforced in SQL layer.
//
// Notes:
// - SQL mirror files in db/sql must reflect these entities 1:1.
// - RLS is applied in db/sql/005_rls_policies.sql (Phase 2 module file).
// - Survey system supports polling + meeting links + scheduling.
// - Voice hooks: audio attachments + transcripts + optional analysis artifacts (pipeline later).
// - AI layer: pragmatic normalized; section-level citations; scope table to avoid schema churn.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  // IMPORTANT: this enables Prisma to work across both schemas.
  schemas = ["public", "private"]
}

//
// -----------------------------
// Shared enums (cross-domain)
// -----------------------------

enum PublishStatus {
  draft
  reviewed
  published

  @@schema("public")
}

enum YesNoUnknown {
  yes
  no
  unknown

  @@schema("public")
}

//
// -----------------------------
// PUBLIC: Core content + trust
// -----------------------------

model County {
  id       String  @id @default(uuid()) @db.Uuid
  name     String
  slug     String  @unique
  fipsCode String? @unique
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  blueprintSections BlueprintSection[]
  quotes            Quote[]
  assets            Asset[]
  countyIssues      CountyIssue[]

  censusMetrics CensusMetric[]
  blsMetrics    BLSMetric[]

  civicsOfficials CivicsOfficial[]
  electionResults ElectionResult[]

  surveyForms     SurveyForm[]
  surveyResponses SurveyResponse[]

  aiOutputScopes AIOutputScope[]
  sourceLinks    SourceDocumentLink[]

  @@schema("public")
}

model Issue {
  id       String  @id @default(uuid()) @db.Uuid
  name     String
  slug     String  @unique
  summary  String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  countyIssues      CountyIssue[]
  blueprintSections BlueprintSection[]
  quotes            Quote[]
  assets            Asset[]

  aiOutputScopes AIOutputScope[]
  sourceLinks    SourceDocumentLink[]

  @@schema("public")
}

model CountyIssue {
  id        String  @id @default(uuid()) @db.Uuid
  countyId  String  @db.Uuid
  issueId   String  @db.Uuid
  featured  Boolean @default(false)
  sortOrder Int? // editorial ordering

  createdAt DateTime @default(now())

  county County @relation(fields: [countyId], references: [id], onDelete: Cascade)
  issue  Issue  @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([countyId, issueId])
  @@index([issueId])
  @@schema("public")
}

model BlueprintSection {
  id     String @id @default(uuid()) @db.Uuid
  slug   String @unique
  title  String
  // Store markdown for content sections
  bodyMd String

  // Scope (nullable to allow global sections later)
  countyId String? @db.Uuid
  issueId  String? @db.Uuid

  // Optional ordering / pinning
  sortOrder Int?
  isPinned  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  county County? @relation(fields: [countyId], references: [id], onDelete: SetNull)
  issue  Issue?  @relation(fields: [issueId], references: [id], onDelete: SetNull)

  sourceLinks SourceDocumentLink[]

  @@index([countyId])
  @@index([issueId])
  @@schema("public")
}

model Quote {
  id               String  @id @default(uuid()) @db.Uuid
  // Privacy-aware: no direct PII
  text             String
  // Optional: a short label like "Listening session attendee"
  attributionLabel String?

  countyId String  @db.Uuid
  issueId  String? @db.Uuid

  // Trust markers (optional): where it came from
  sourceNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  county County @relation(fields: [countyId], references: [id], onDelete: Cascade)
  issue  Issue? @relation(fields: [issueId], references: [id], onDelete: SetNull)

  sourceLinks SourceDocumentLink[]

  @@index([countyId])
  @@index([issueId])
  @@schema("public")
}

enum AssetType {
  photo
  document
  audio
  video
  other

  @@schema("public")
}

model Asset {
  id        String    @id @default(uuid()) @db.Uuid
  assetType AssetType @default(other)

  title   String?
  caption String?
  credit  String?
  license String?

  // Storage pointer (do not store secrets here)
  url        String?
  storageKey String?

  countyId String? @db.Uuid
  issueId  String? @db.Uuid

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  county County? @relation(fields: [countyId], references: [id], onDelete: SetNull)
  issue  Issue?  @relation(fields: [issueId], references: [id], onDelete: SetNull)

  sourceLinks SourceDocumentLink[]

  @@index([countyId])
  @@index([issueId])
  @@schema("public")
}

model GlossaryTerm {
  id           String  @id @default(uuid()) @db.Uuid
  term         String  @unique
  slug         String  @unique
  definitionMd String
  examplesMd   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

model SourceDocument {
  id String @id @default(uuid()) @db.Uuid

  title      String
  // public-safe source URL or file reference
  url        String?
  // optional: storage pointer
  storageKey String?

  // origin metadata
  publisher   String?
  publishedAt DateTime?
  capturedAt  DateTime?

  // method note (how obtained / why trusted)
  methodNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chunks      SourceChunk[]
  citations   Citation[]
  runInputs   AIRunInputSource[]
  sourceLinks SourceDocumentLink[]

  @@schema("public")
}

model SourceChunk {
  id               String @id @default(uuid()) @db.Uuid
  sourceDocumentId String @db.Uuid

  chunkIndex  Int
  content     String
  contentHash String

  // Locator info such as page number, timestamps, offsets, etc.
  locatorJson Json?

  createdAt DateTime @default(now())

  sourceDocument SourceDocument @relation(fields: [sourceDocumentId], references: [id], onDelete: Cascade)
  citations      Citation[]

  @@unique([sourceDocumentId, chunkIndex])
  @@index([contentHash])
  @@schema("public")
}

// Lightweight generic linking of source docs to public entities for "trust markers"
// Prisma does not do true polymorphism well; we use optional foreign keys.
model SourceDocumentLink {
  id               String @id @default(uuid()) @db.Uuid
  sourceDocumentId String @db.Uuid

  countyId           String? @db.Uuid
  issueId            String? @db.Uuid
  blueprintSectionId String? @db.Uuid
  quoteId            String? @db.Uuid
  assetId            String? @db.Uuid
  surveyFormId       String? @db.Uuid

  note      String?
  createdAt DateTime @default(now())

  sourceDocument   SourceDocument    @relation(fields: [sourceDocumentId], references: [id], onDelete: Cascade)
  county           County?           @relation(fields: [countyId], references: [id], onDelete: SetNull)
  issue            Issue?            @relation(fields: [issueId], references: [id], onDelete: SetNull)
  blueprintSection BlueprintSection? @relation(fields: [blueprintSectionId], references: [id], onDelete: SetNull)
  quote            Quote?            @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  asset            Asset?            @relation(fields: [assetId], references: [id], onDelete: SetNull)
  surveyForm       SurveyForm?       @relation(fields: [surveyFormId], references: [id], onDelete: SetNull)

  @@index([sourceDocumentId])
  @@index([countyId])
  @@index([issueId])
  @@schema("public")
}

//
// -----------------------------
// PUBLIC: Metrics + civics + geo
// -----------------------------

model GeoCounty {
  id        String   @id @default(uuid()) @db.Uuid
  fipsCode  String?  @unique
  name      String
  // Geometry stored elsewhere (PostGIS) later if desired; keep minimal here.
  createdAt DateTime @default(now())

  @@schema("public")
}

model GeoZip {
  id        String   @id @default(uuid()) @db.Uuid
  zipCode   String   @unique
  createdAt DateTime @default(now())

  censusMetrics   CensusMetric[]
  aiOutputScopes  AIOutputScope[]
  electionResults ElectionResult[]

  @@schema("public")
}

model GeoPrecinct {
  id           String   @id @default(uuid()) @db.Uuid
  name         String?
  precinctCode String?
  createdAt    DateTime @default(now())

  electionResults ElectionResult[]

  @@schema("public")
}

model GeoDistrict {
  id           String   @id @default(uuid()) @db.Uuid
  districtCode String   @unique
  districtType String?
  createdAt    DateTime @default(now())

  civicsOfficials CivicsOfficial[]
  aiOutputScopes  AIOutputScope[]

  @@schema("public")
}

enum CrosswalkType {
  zip_to_county
  precinct_to_district
  precinct_to_county
  zip_to_district
  other

  @@schema("public")
}

model GeoCrosswalk {
  id            String        @id @default(uuid()) @db.Uuid
  crosswalkType CrosswalkType

  fromGeoZipId      String? @db.Uuid
  fromGeoPrecinctId String? @db.Uuid
  fromGeoDistrictId String? @db.Uuid
  fromGeoCountyFips String?

  toGeoZipId      String? @db.Uuid
  toGeoPrecinctId String? @db.Uuid
  toGeoDistrictId String? @db.Uuid
  toGeoCountyFips String?

  weight    Float?
  createdAt DateTime @default(now())

  @@index([crosswalkType])
  @@schema("public")
}

model CensusMetric {
  id String @id @default(uuid()) @db.Uuid

  countyId String? @db.Uuid
  geoZipId String? @db.Uuid

  metricKey   String
  metricLabel String?
  value       Float?
  valueText   String?

  asOfDate   DateTime?
  sourceNote String?

  createdAt DateTime @default(now())

  county County? @relation(fields: [countyId], references: [id], onDelete: SetNull)
  geoZip GeoZip? @relation(fields: [geoZipId], references: [id], onDelete: SetNull)

  @@index([countyId])
  @@index([geoZipId])
  @@index([metricKey])
  @@schema("public")
}

model BLSMetric {
  id String @id @default(uuid()) @db.Uuid

  countyId String @db.Uuid

  seriesKey   String
  seriesLabel String?
  value       Float?
  asOfDate    DateTime?
  sourceNote  String?

  createdAt DateTime @default(now())

  county County @relation(fields: [countyId], references: [id], onDelete: Cascade)

  @@index([countyId])
  @@index([seriesKey])
  @@schema("public")
}

model CivicsOfficial {
  id String @id @default(uuid()) @db.Uuid

  name       String
  officeName String
  party      String?
  phone      String?
  website    String?
  photoUrl   String?

  countyId   String? @db.Uuid
  districtId String? @db.Uuid

  sourceNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  county   County?      @relation(fields: [countyId], references: [id], onDelete: SetNull)
  district GeoDistrict? @relation(fields: [districtId], references: [id], onDelete: SetNull)

  @@index([countyId])
  @@index([districtId])
  @@schema("public")
}

model Election {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  electionDate DateTime
  electionType String?
  notes        String?

  createdAt DateTime @default(now())

  results ElectionResult[]

  @@index([electionDate])
  @@schema("public")
}

model ElectionResult {
  id String @id @default(uuid()) @db.Uuid

  electionId String  @db.Uuid
  countyId   String? @db.Uuid
  geoZipId   String? @db.Uuid
  precinctId String? @db.Uuid

  choiceLabel String
  votes       Int?
  voteShare   Float?

  createdAt DateTime @default(now())

  election Election     @relation(fields: [electionId], references: [id], onDelete: Cascade)
  county   County?      @relation(fields: [countyId], references: [id], onDelete: SetNull)
  geoZip   GeoZip?      @relation(fields: [geoZipId], references: [id], onDelete: SetNull)
  precinct GeoPrecinct? @relation(fields: [precinctId], references: [id], onDelete: SetNull)

  @@index([electionId])
  @@index([countyId])
  @@index([precinctId])
  @@schema("public")
}

//
// -----------------------------
// PUBLIC: AI layer (grounded)
// -----------------------------

enum AIRunStatus {
  queued
  running
  succeeded
  failed
  canceled

  @@schema("public")
}

enum AIOutputType {
  county_brief
  issue_brief
  zip_snapshot
  talking_points
  action_options
  glossary_draft
  other

  @@schema("public")
}

enum AIScopeType {
  county
  issue
  zip
  district
  statewide
  custom

  @@schema("public")
}

model AIPrompt {
  id String @id @default(uuid()) @db.Uuid

  promptKey   String
  version     Int
  name        String
  description String?
  template    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs AIRun[]

  @@unique([promptKey, version])
  @@index([promptKey])
  @@schema("public")
}

model AIRun {
  id String @id @default(uuid()) @db.Uuid

  promptId   String @db.Uuid
  model      String
  paramsJson Json?

  status      AIRunStatus @default(queued)
  startedAt   DateTime?
  completedAt DateTime?
  errorText   String?

  inputSummary String?
  createdAt    DateTime @default(now())

  prompt AIPrompt @relation(fields: [promptId], references: [id], onDelete: Cascade)

  outputs      AIOutput[]
  inputSources AIRunInputSource[]
  analyses     AIAnalysis[]

  @@index([promptId])
  @@index([status])
  @@schema("public")
}

enum AIRunInputKind {
  source_document
  dataset
  manual_note
  other

  @@schema("public")
}

model AIRunInputSource {
  id    String @id @default(uuid()) @db.Uuid
  runId String @db.Uuid

  kind             AIRunInputKind @default(source_document)
  sourceDocumentId String?        @db.Uuid

  externalKey String?
  notes       String?

  createdAt DateTime @default(now())

  run            AIRun           @relation(fields: [runId], references: [id], onDelete: Cascade)
  sourceDocument SourceDocument? @relation(fields: [sourceDocumentId], references: [id], onDelete: SetNull)

  @@index([runId])
  @@index([sourceDocumentId])
  @@schema("public")
}

model AIOutput {
  id String @id @default(uuid()) @db.Uuid

  runId      String        @db.Uuid
  outputType AIOutputType  @default(other)
  status     PublishStatus @default(draft)

  title     String?
  summary   String?
  contentMd String

  reviewedAt  DateTime?
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run AIRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  sections AIOutputSection[]
  scopes   AIOutputScope[]

  @@index([runId])
  @@index([status])
  @@index([outputType])
  @@schema("public")
}

model AIOutputSection {
  id String @id @default(uuid()) @db.Uuid

  outputId   String  @db.Uuid
  sectionKey String
  heading    String?
  order      Int     @default(0)

  contentMd String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  output    AIOutput   @relation(fields: [outputId], references: [id], onDelete: Cascade)
  citations Citation[]

  @@unique([outputId, sectionKey])
  @@index([outputId])
  @@schema("public")
}

model AIOutputScope {
  id String @id @default(uuid()) @db.Uuid

  outputId  String      @db.Uuid
  scopeType AIScopeType

  countyId   String? @db.Uuid
  issueId    String? @db.Uuid
  geoZipId   String? @db.Uuid
  districtId String? @db.Uuid

  customKey String?
  createdAt DateTime @default(now())

  output   AIOutput     @relation(fields: [outputId], references: [id], onDelete: Cascade)
  county   County?      @relation(fields: [countyId], references: [id], onDelete: SetNull)
  issue    Issue?       @relation(fields: [issueId], references: [id], onDelete: SetNull)
  geoZip   GeoZip?      @relation(fields: [geoZipId], references: [id], onDelete: SetNull)
  district GeoDistrict? @relation(fields: [districtId], references: [id], onDelete: SetNull)

  @@index([outputId])
  @@index([scopeType])
  @@index([countyId])
  @@index([issueId])
  @@index([geoZipId])
  @@index([districtId])
  @@schema("public")
}

model Citation {
  id String @id @default(uuid()) @db.Uuid

  outputSectionId  String  @db.Uuid
  sourceChunkId    String? @db.Uuid
  sourceDocumentId String? @db.Uuid

  label       String?
  locatorJson Json?

  createdAt DateTime @default(now())

  outputSection  AIOutputSection @relation(fields: [outputSectionId], references: [id], onDelete: Cascade)
  sourceChunk    SourceChunk?    @relation(fields: [sourceChunkId], references: [id], onDelete: SetNull)
  sourceDocument SourceDocument? @relation(fields: [sourceDocumentId], references: [id], onDelete: SetNull)

  @@index([outputSectionId])
  @@index([sourceChunkId])
  @@index([sourceDocumentId])
  @@schema("public")
}

//
// -----------------------------
// PUBLIC: Surveys / polling + voice hooks
// -----------------------------

enum SurveyFormStatus {
  draft
  active
  closed
  archived

  @@schema("public")
}

enum SurveyQuestionType {
  text
  long_text
  number
  boolean
  single_select
  multi_select
  rating

  @@schema("public")
}

model SurveyForm {
  id String @id @default(uuid()) @db.Uuid

  title         String
  descriptionMd String?
  slug          String  @unique

  status SurveyFormStatus @default(draft)

  startAt DateTime?
  endAt   DateTime?

  countyId     String? @db.Uuid
  contextLabel String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  county County? @relation(fields: [countyId], references: [id], onDelete: SetNull)

  questions SurveyQuestion[]
  responses SurveyResponse[]

  sourceLinks SourceDocumentLink[]

  @@index([countyId])
  @@index([status])
  @@schema("public")
}

model SurveyQuestion {
  id String @id @default(uuid()) @db.Uuid

  formId String @db.Uuid

  questionKey String
  prompt      String
  helpText    String?

  questionType SurveyQuestionType
  required     Boolean            @default(false)

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  allowVoice Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  form SurveyForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  options       SurveyQuestionOption[]
  responseItems SurveyResponseItem[]

  @@unique([formId, questionKey])
  @@index([formId])
  @@schema("public")
}

model SurveyQuestionOption {
  id String @id @default(uuid()) @db.Uuid

  questionId String  @db.Uuid
  valueKey   String
  label      String
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())

  question SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  responseItemOptions SurveyResponseItemOption[]

  // FIX: opposite side of SurveyResponseItem.selectedOption
  selectedByResponseItems SurveyResponseItem[] @relation("SelectedOption")

  @@unique([questionId, valueKey])
  @@index([questionId])
  @@schema("public")
}

model SurveyResponse {
  id String @id @default(uuid()) @db.Uuid

  formId   String  @db.Uuid
  countyId String? @db.Uuid

  sourceLabel String?
  submittedAt DateTime @default(now())

  ipHash    String?
  userAgent String?

  createdAt DateTime @default(now())

  form   SurveyForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  county County?    @relation(fields: [countyId], references: [id], onDelete: SetNull)

  items SurveyResponseItem[]

  @@index([formId])
  @@index([countyId])
  @@schema("public")
}

model SurveyResponseItem {
  id String @id @default(uuid()) @db.Uuid

  responseId String @db.Uuid
  questionId String @db.Uuid

  valueText    String?
  valueNumber  Float?
  valueBoolean Boolean?

  selectedOptionId String? @db.Uuid
  mediaAssetId     String? @db.Uuid

  createdAt DateTime @default(now())

  response SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // FIX: name the relation so Prisma can match both sides
  selectedOption SurveyQuestionOption? @relation("SelectedOption", fields: [selectedOptionId], references: [id], onDelete: SetNull)

  mediaAsset MediaAsset? @relation(fields: [mediaAssetId], references: [id], onDelete: SetNull)

  multiSelectedOptions SurveyResponseItemOption[]

  @@index([responseId])
  @@index([questionId])
  @@index([selectedOptionId])
  @@index([mediaAssetId])
  @@schema("public")
}

model SurveyResponseItemOption {
  id String @id @default(uuid()) @db.Uuid

  responseItemId String @db.Uuid
  optionId       String @db.Uuid

  createdAt DateTime @default(now())

  responseItem SurveyResponseItem   @relation(fields: [responseItemId], references: [id], onDelete: Cascade)
  option       SurveyQuestionOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([responseItemId, optionId])
  @@index([optionId])
  @@schema("public")
}

model MediaAsset {
  id String @id @default(uuid()) @db.Uuid

  assetType AssetType @default(audio)

  storageProvider String?
  storageKey      String?
  url             String?

  mimeType   String?
  sizeBytes  Int?
  durationMs Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  surveyResponseItems SurveyResponseItem[]
  transcripts         Transcript[]

  // FIX: opposite side of AIAnalysis.mediaAsset
  analyses AIAnalysis[] @relation("MediaAssetAnalyses")

  @@index([assetType])
  @@schema("public")
}

model Transcript {
  id           String @id @default(uuid()) @db.Uuid
  mediaAssetId String @db.Uuid

  provider        String?
  providerVersion String?
  language        String?

  transcriptText String
  segmentsJson   Json?

  createdAt DateTime @default(now())

  mediaAsset MediaAsset   @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
  analyses   AIAnalysis[]

  @@index([mediaAssetId])
  @@schema("public")
}

enum AnalysisType {
  transcription_summary
  sentiment_estimate
  emotion_tags_estimate
  speaking_rate_estimate
  other

  @@schema("public")
}

model AIAnalysis {
  id String @id @default(uuid()) @db.Uuid

  transcriptId String? @db.Uuid
  mediaAssetId String? @db.Uuid
  aiRunId      String? @db.Uuid

  analysisType AnalysisType @default(other)
  contentJson  Json
  notes        String?

  createdAt DateTime @default(now())

  transcript Transcript? @relation(fields: [transcriptId], references: [id], onDelete: SetNull)

  // FIX: named relation + backref on MediaAsset
  mediaAsset MediaAsset? @relation("MediaAssetAnalyses", fields: [mediaAssetId], references: [id], onDelete: SetNull)

  aiRun AIRun? @relation(fields: [aiRunId], references: [id], onDelete: SetNull)

  @@index([analysisType])
  @@index([transcriptId])
  @@index([mediaAssetId])
  @@index([aiRunId])
  @@schema("public")
}

//
// -----------------------------
// PRIVATE: Voter file zone (PII)
// -----------------------------

enum ImportJobKind {
  voter_registration
  vote_history
  other

  @@schema("private")
}

enum ImportJobStatus {
  queued
  running
  succeeded
  failed

  @@schema("private")
}

model VoterRegistration {
  id String @id @default(uuid()) @db.Uuid

  stateVoterId String @unique

  firstName   String?
  middleName  String?
  lastName    String?
  suffix      String?
  dateOfBirth DateTime?

  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zip          String?

  party  String?
  status String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  voteHistory        VoteHistory[]
  segmentMemberships SegmentMember[]

  @@schema("private")
}

model VoteHistory {
  id String @id @default(uuid()) @db.Uuid

  voterId      String    @db.Uuid
  electionDate DateTime?
  electionName String?
  voteType     String?

  createdAt DateTime @default(now())

  voter VoterRegistration @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@index([voterId])
  @@index([electionDate])
  @@schema("private")
}

model Segment {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  slug        String  @unique
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members SegmentMember[]

  @@schema("private")
}

model SegmentMember {
  id String @id @default(uuid()) @db.Uuid

  segmentId String @db.Uuid
  voterId   String @db.Uuid

  createdAt DateTime @default(now())

  segment Segment           @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  voter   VoterRegistration @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([segmentId, voterId])
  @@index([voterId])
  @@schema("private")
}

model ImportJob {
  id String @id @default(uuid()) @db.Uuid

  kind   ImportJobKind   @default(other)
  status ImportJobStatus @default(queued)

  fileName String?
  fileHash String?
  rowCount Int?

  startedAt   DateTime?
  completedAt DateTime?
  errorText   String?

  createdAt DateTime @default(now())

  auditLogs AuditLog[]

  @@index([kind])
  @@index([status])
  @@schema("private")
}

model AuditLog {
  id String @id @default(uuid()) @db.Uuid

  actorLabel String?
  action     String
  entityType String?
  entityId   String?

  metadataJson Json?

  importJobId String? @db.Uuid

  createdAt DateTime @default(now())

  importJob ImportJob? @relation(fields: [importJobId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([action])
  @@schema("private")
}
